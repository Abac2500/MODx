/*!
 * TinyMCE Rich Text Editor - TinyMCE 5
 * Version: 2.0.8
 * Build date: 2022-08-01
 */
Ext.ns("TinyMCERTE"),TinyMCERTE.Tiny=function(t,e){Ext.apply(this.cfg,e,{}),TinyMCERTE.Tiny.superclass.constructor.call(this,t)},Ext.extend(TinyMCERTE.Tiny,Ext.Component,{cfg:{selector:"#ta",document_base_url:MODx.config.base_url,file_picker_types:"file image media"},allowDrop:!1,initComponent:function(){TinyMCERTE.Tiny.superclass.initComponent.call(this),Ext.onReady(this.render,this)},editor:null,render:function(){var e=this;Ext.apply(this.cfg,TinyMCERTE.editorConfig,{}),this.cfg.file_picker_callback=this.loadBrowser,this.cfg.link_list=this.cfg.enable_link_list?this.linkList:null,this.cfg.init_instance_callback=function(t){(e.editor=t).on("change",function(){tinymce.triggerSave()});var n=MODx.config.keymap_save||"s";t.addShortcut("ctrl+"+n,"",function(){var e,t=Ext.getCmp("modx-abtn-save");t&&!t.disabled&&t.keys&&(e=!1,Ext.each(t.keys,function(t){if(!0===t.ctrl&&t.key===n)return!(e=!0)}),e&&t.el.dom.click())}),e.allowDrop&&e.registerDrop()},tinymce.init(this.cfg)},loadBrowser:function(n,t,e){var i=MODx.config.manager_url+"index.php?a=browser&source="+MODx.config.default_media_source+(MODx.ctx?"&ctx="+MODx.ctx:"")+(MODx.request.id?"&id="+MODx.request.id:"");tinyMCE.activeEditor.windowManager.openUrl({title:_("modx_browser"),url:i,width:1200,height:600,onMessage:function(t,e){"selectFile"===e.mceAction&&(n(e.url,{}),t.close())}})},linkList:function(e){var t=TinyMCERTE.editorConfig.connector_url+"?action=mgr/resource/gettree"+(MODx.ctx?"&wctx="+MODx.ctx:"")+"&HTTP_MODAUTH="+MODx.siteId;fetch(t).then(function(t){return t.json()}).then(function(t){return e(t.results||[])})},registerDrop:function(){var i=this.editor,s=null,o=new Ext.Element(this.editor.getContainer()),c=o.dom,a={text:function(t){i.insertContent(t),i.focus()},link:function(t,e){i.insertContent('<a href="[[~'+t+']]" title="'+e+'">'+e+"</a>"),i.focus()},image:function(t){i.insertContent('<img src="'+t+'">'),i.focus()}},e=new Ext.dd.DropTarget(c,{ddGroup:"modx-treedrop-dd",_notifyEnter:function(t,e,n){s=Ext.DomHelper.insertAfter(o,{tag:"div",style:"position: absolute;top: 0;left: 0;right: 0;bottom: 0;"}),o.frame(),i.focus()},notifyOut:function(t,e,n){s&&s.remove(),o.on("mouseover",r)},notifyDrop:function(t,e,n){console.log(n),s&&s.remove();var i,o=!1;switch(n.node.attributes.type){case"modResource":a.link(n.node.attributes.pk,n.node.text.replace(/\s*<.*>.*<.*>/,""));break;case"snippet":case"chunk":case"tv":o=!0;break;case"file":var r=n.node.attributes.text.substring(n.node.attributes.text.lastIndexOf(".")+1);-1!==["jpg","jpeg","png","gif","svg"].indexOf(r)?a.image(n.node.attributes.url):a.text(n.node.attributes.url);break;default:r=Ext.getCmp(n.node.attributes.type+"-drop-handler");return r?r.handle(n,{ddTargetEl:c,cfg:cfg,iframe:!0,iframeEl:c,onInsert:a.text}):!1}return o&&(i={pk:n.node.attributes.pk,classKey:n.node.attributes.classKey,name:n.node.attributes.name,output:"",ddTargetEl:c,cfg:{onInsert:a.text},iframe:!0,onInsert:a.text},TinyMCERTE.insertWindow&&(TinyMCERTE.insertWindow.destroy(),TinyMCERTE.insertWindow.close()),TinyMCERTE.insertWindow=MODx.load({xtype:"modx-window-insert-element",record:i,closeAction:"close",listeners:{success:{fn:function(){},scope:this},close:{fn:function(){this.destroy(),this.close()}}}}),TinyMCERTE.insertWindow.setValues(i),TinyMCERTE.insertWindow.show()),!0}}),r=(e.addToGroup("modx-treedrop-elements-dd"),e.addToGroup("modx-treedrop-sources-dd"),function(t){Ext.dd.DragDropMgr.dragCurrent&&(e._notifyEnter(),o.un("mouseover",r))});o.on("mouseover",r),this.on("destroy",function(){e.destroy()})}}),TinyMCERTE.loadForTVs=function(){new TinyMCERTE.Tiny({allowDrop:!0},{selector:".modx-richtext"})},MODx.loadRTE=function(t){new TinyMCERTE.Tiny({allowDrop:!0},{selector:"#"+t})};